#!/system/xbin/bash

# modify by ac1965 AT gmail DOT com
# original from git://github.com/alienmind/ICEDroid.git

set -e

PRESET_PATH="/sdcard/tjyMOD"
DEFAULT_MARKET_VERSION="2.3.6"

declare -A CMD=(\
  [help]="This Messages" \
	[reboot]="Reboot phone" \
	[fastchargeon]="High power charging Enabled" \
	[fastchargeoff]="High power charging Disabled" \
	[remountsysrw]="/system remount read-write" \
	[remountsysro]="/system remount read-only" \
	[chargedisable]="Charge on plug Disabled" \
	[chargeenable]="Charge on plug Enabled" \
	[market]="Other Version Market Apply" \
	[gpsconf]="GPS Configuration" \
	[dspinit]="DSP Profile Configuration" \
	[ril]="RIL Switch and Reboot" \
	[density]="Density Configuration" \
)


die () {
	echo "$1"
	exit 1
}

Remount () {
	local mode=$1
	mount -o remount,$mode /system
}

Reboot () {
	local grace_time=$1
	printf "Syncing...\n"
	sync;sync;sync
	printf "Rebooting in $grace_time seconds...\n"
	for i in $(seq 1 $grace_time)
	do
		printf "%d." $i
	done
	printf "\n"
	reboot
}

InstallMarket () {
	local APK=$1
	local APPF="/system/app/Vending.apk"
	Remount "rw"
	pm uninstall com.android.vending
	rm -f /data/app/com.android.venging*apk
	cp $APK $APPF
	chmod 644 $APPF
	pm install $APPF
	Remount "ro"
}

LauncherMarket () {
	am start -a android.intent.action.MAIN \
		-n com.android.vending/com.android.vending.AssetBrowserActivity
}

fastchageron () {
	echo "1" > /sys/class/power_supply/battery/force_high_power_charging
	echo "High power charging enabled"
}

fastchageroff () {
	echo "0" > /sys/class/power_supply/battery/force_high_power_charging
	echo "High power charging disabled"
}

remountstatus () {
	local MODE=$1
	local MESSG=$2
	Remount $MODE
	mount | grep system | grep "${MODE}"
	case "$?" in
		0) echo "$2";;
	esac
}

charge () {
	local VALUE=$1
	local MESSG=$2
	echo $VALUE > /sys/devices/platform/rs30100001:00000000/power_supply/battery/charge_on_plug_enabled
	echo "$MESSG"
}

market () {
	local VER=$1
        APK=${PRESET_PATH}/market/Vending-${VER}.apk
  	if [ -f $APK ]; then
    		InstallMarket $APK
    		LauncherMarket
    		echo "Market reverted to new version $VER"
  	else
    		die "Couldn't find Market version $VER" 
  	fi
}

gpsconf () {
	local F=$1
	ZIP=${PRESET_PATH}/gps/conf/$F
	if [ -f "$ZIP" ]; then
		Remount "rw"
		cd /
		unzip -o $ZIP system/etc/gps.conf
		case "$?" in
		0) "GPS configuration for $F applied - open GPS Status and redownload AGPS data";;
		*) "Error extracting /system/etc/gps.conf from $ZIP";;
		esac
		Remount "ro"
	else
		echo "Nonexistent $ZIP!!!"
	fi
}

dspinit () {
	local MODE=$1
	snd3254 -dspmode $MODE
	echo "DSP profile for $MODE applied"
}

ril () {
	local DN=$1
	DIR=${PRESET_PATH}/ril/$DN
	printf "RIL before patch: "
	getprop | grep RIL | cut -d'[' -f3 | cut -d ']' -f1
	test -z "$DZ" && die "Error: Please specify RIL"
	if [ -d "$DIR" ]; then
		Remount "rw"
		cp -r $DIR/* /
		Remount "ro"
		echo "RIL switched to $DN. Rebooting is highly recommended!"
    	else
		die "Error: $DIR does not exist"
	fi
}

density () {
	local DENSITY=$1 # 240<= DENSITY >= 190
	CHAR_STOP=$(expr "$DENSITY" : '\([0-9]*\)')
	test "$DENSITY" != "$CHAR_STOP" && die "Illegal Value : $DENSITY"
	test $DENSITY -ge 190 -a $DENSITY -le 240 || die "Illegal Value Density:$DENSITY (240<= DENSITY >=190)"
	Remount "rw"
  	sed -i "s/ro.sf.lcd_density=.*/ro.sf.lcd_density=$DENSITY/g" /system/build.prop
  	Remount "ro"
  	Reboot 5
}

help () {
	printf "Usage: $MYNAME CMD Option\n\n"
	printf "CMD:\n"
	for d in \
		help \
		reboot \
		fastchargeon \
		fastchargeoff \
		remountsysrw \
		remountsysro \
		chargedisable \
		chargeenable \
		market \
		gpsconf \
		dspinit \
		ril \
		density
	do
		echo -e "$d\t: ${CMD[$d]}"
	done
	exit 0
}

test x"$(whoami)" = x"root" || die "Must be root"

case "$1" in
	reboot) Reboot 5;;
	fastchargeron) fastchargeron;;
	fastchargeroff) fastchargeroff;;
	remountsysrw) remountstatus "rw" "/system remounted read-wrie";;
	remountsysro) remountstatus "ro" "/system remounted read-only";;
	chargedisable) charge 0 "Charge on plug disabled - unplug/plug to make it work";;
	chargeenable) charge 1 "Charge on plug enabled - unplug/plug to make it work";;
	market) market $2;;
	gpsconf) gpsconf $2;;
	dspinit) dspinit $2;;
	ril) ril $2;;
	density) density $2;;
	--help|-help|-h|-?|"") help;;
	*)
		exec $@;;
esac

exit 0